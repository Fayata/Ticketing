{% extends "dashboard_layout.html" %}
{% load static %}

{% block title %}Tiket Saya - Portal Ticketing{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ticket-components.css' %}">
{% endblock %}

{% block page_title %}Tiket Saya{% endblock %}
{% block page_subtitle %}Kelola semua tiket support Anda{% endblock %}

{% block content %}
<!-- Filters Bar -->
<div class="filters-bar">
    <form method="GET" class="filters-form">
        <div class="filter-group">
            <label>Cari Tiket</label>
            <input type="text" 
                   name="search" 
                   value="{{ search_query }}" 
                   placeholder="Cari berdasarkan judul, deskripsi, atau ID..." 
                   class="filter-input">
        </div>
        
        <div class="filter-group">
            <label>Status</label>
            <select name="status" class="filter-select">
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Semua Status</option>
                <option value="OPEN" {% if status_filter == 'OPEN' %}selected{% endif %}>Open</option>
                <option value="IN_PROGRESS" {% if status_filter == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                <option value="CLOSED" {% if status_filter == 'CLOSED' %}selected{% endif %}>Closed</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Prioritas</label>
            <select name="priority" class="filter-select">
                <option value="all" {% if priority_filter == 'all' %}selected{% endif %}>Semua Prioritas</option>
                <option value="LOW" {% if priority_filter == 'LOW' %}selected{% endif %}>Low</option>
                <option value="MEDIUM" {% if priority_filter == 'MEDIUM' %}selected{% endif %}>Medium</option>
                <option value="HIGH" {% if priority_filter == 'HIGH' %}selected{% endif %}>High</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>&nbsp;</label>
            <button type="submit" class="filter-btn">Terapkan Filter</button>
        </div>
    </form>
</div>

<!-- Tickets List Card -->
<div class="card">
    <div class="card-header">
        <h2>{{ tickets.count }} Tiket Ditemukan</h2>
        {% if search_query or status_filter != 'all' or priority_filter != 'all' %}
        <a href="{% url 'my-tickets' %}" class="btn-outline btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Reset Filter
        </a>
        {% endif %}
    </div>
    
    <div class="card-body" style="padding: 0;">
        {% if tickets %}
        <div class="ticket-list">
            {% for ticket in tickets %}
            <div class="ticket-item" onclick="window.location.href='#'">
                <div class="ticket-header">
                    <div>
                        <div class="ticket-id-status">
                            <span class="ticket-id">#TKT-{{ ticket.id }}</span>
                            <span class="status-badge {% if ticket.status == 'OPEN' %}open{% elif ticket.status == 'IN_PROGRESS' %}in-progress{% else %}closed{% endif %}">
                                {{ ticket.get_status_display }}
                            </span>
                        </div>
                        
                        <h3 class="ticket-title">{{ ticket.title }}</h3>
                        
                        <p class="ticket-description">{{ ticket.description|truncatewords:30 }}</p>
                        
                        <div class="ticket-meta">
                            <span class="ticket-meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                {{ ticket.department.name|default:"Umum" }}
                            </span>
                            
                            <span class="ticket-meta-item priority-{% if ticket.priority == 'HIGH' %}high{% elif ticket.priority == 'MEDIUM' %}medium{% else %}low{% endif %}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                {{ ticket.get_priority_display }}
                            </span>
                            
                            <span class="ticket-meta-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                {{ ticket.replies.count }} balasan
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="ticket-footer">
                    <span>Dibuat: {{ ticket.created_at|date:"d M Y, H:i" }}</span>
                    <span>Update terakhir: {{ ticket.updated_at|timesince }} lalu</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <h3>Tidak Ada Tiket Ditemukan</h3>
            <p>Tidak ada tiket yang sesuai dengan kriteria pencarian Anda</p>
            <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-top: var(--spacing-md);">
                <a href="{% url 'my-tickets' %}" class="btn-outline">Reset Filter</a>
                <a href="{% url 'create-ticket' %}" class="btn-primary">Buat Tiket Baru</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <a href="{% url 'create-ticket' %}" class="quick-action-btn">
        <div class="quick-action-icon red">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </div>
        <p>Buat Tiket Baru</p>
    </a>
    
    <a href="#" class="quick-action-btn">
        <div class="quick-action-icon green">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <p>Tiket Selesai</p>
    </a>
    
    <a href="#" class="quick-action-btn">
        <div class="quick-action-icon blue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
        </div>
        <p>Knowledge Base</p>
    </a>
    
    <a href="#" class="quick-action-btn">
        <div class="quick-action-icon purple">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="10" r="3"></circle>
                <path d="M6.17 18.25A7 7 0 0 1 17.83 18.25"></path>
            </svg>
        </div>
        <p>Hubungi Support</p>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Add search debounce
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            // Optional: auto-submit form after typing stops
            // this.form.submit();
        }, 500);
    });
}

// Add loading state to filter button
const filterForm = document.querySelector('.filters-form');
if (filterForm) {
    filterForm.addEventListener('submit', function() {
        const submitBtn = this.querySelector('.filter-btn');
        window.commonUtils.setFormLoading(this, true);
    });
}
</script>
{% endblock %}